name: Build Chrome Extension (.crx)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-crx:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y zip openssl xxd

    - name: Create extension ZIP
      run: |
        mkdir -p dist
        zip -r dist/LemurDevToolsPro.zip LemurDevToolsPro -x "*.pem" -x ".*"

    - name: Write private key from GitHub Secret
      run: |
        echo "${{ secrets.CRX_PRIVATE_KEY }}" > key.pem

    - name: Create CRX package
      run: |
        openssl pkcs8 -inform PEM -in key.pem -topk8 -nocrypt > key.dec
        openssl rsa -in key.dec -pubout -out pubkey.pem
        openssl dgst -sha1 -binary -sign key.dec dist/LemurDevToolsPro.zip > signature.bin
        PUBKEY_HEX=$(xxd -p pubkey.pem | tr -d '\n')
        SIG_HEX=$(xxd -p signature.bin | tr -d '\n')

        (
          printf 'Cr24'
          printf '\x02\x00\x00\x00'
          printf "$(printf "%08x" $(expr length $PUBKEY_HEX / 2) | sed 's/../\\x&/g')"
          printf "$(printf "%08x" $(expr length $SIG_HEX / 2) | sed 's/../\\x&/g')"
          printf "$PUBKEY_HEX" | xxd -r -p
          printf "$SIG_HEX" | xxd -r -p
          cat dist/LemurDevToolsPro.zip
        ) > dist/LemurDevToolsPro.crx

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lemur-devtools-build
        path: dist/
